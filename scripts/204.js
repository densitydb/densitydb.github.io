"use strict";(self.webpackChunkassets=self.webpackChunkassets||[]).push([["204"],{62473:function(e,t,r){r.r(t),r.d(t,{AuthenticationStateMachine:()=>z});var n=r(75842),a=r(72668),s=r(88609),i=r(8199),o=r(51647),u=r(20110);function c(e,t,r,n,a,s,i){try{var o=e[s](i),u=o.value}catch(e){r(e);return}o.done?t(u):Promise.resolve(u).then(n,a)}var l=r(4334),f=r(65438),h=r(555),d=r(20110);function p(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function y(e,t,r,n,a,s,i){try{var o=e[s](i),u=o.value}catch(e){r(e);return}o.done?t(u):Promise.resolve(u).then(n,a)}function b(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var s=e.apply(t,r);function i(e){y(s,n,a,i,o,"next",e)}function o(e){y(s,n,a,i,o,"throw",e)}i(void 0)})}}function v(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function g(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){v(e,t,r[t])})}return e}function m(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r,n,a=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=a){var s=[],i=!0,o=!1;try{for(a=a.call(e);!(i=(r=a.next()).done)&&(s.push(r.value),!t||s.length!==t);i=!0);}catch(e){o=!0,n=e}finally{try{i||null==a.return||a.return()}finally{if(o)throw n}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return p(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return p(e,t)}}(e,t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(e,t){var r,n,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=o(0),i.throw=o(1),i.return=o(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(o){return function(u){var c=[o,u];if(r)throw TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(s=0)),s;)try{if(r=1,n&&(a=2&c[0]?n.return:c[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,c[1])).done)return a;switch(n=0,a&&(c=[2&c[0],a.value]),c[0]){case 0:case 1:a=c;break;case 4:return s.label++,{value:c[1],done:!1};case 5:s.label++,n=c[1],c=[0];continue;case 7:c=s.ops.pop(),s.trys.pop();continue;default:if(!(a=(a=s.trys).length>0&&a[a.length-1])&&(6===c[0]||2===c[0])){s=0;continue}if(3===c[0]&&(!a||c[1]>a[0]&&c[1]<a[3])){s.label=c[1];break}if(6===c[0]&&s.label<a[1]){s.label=a[1],a=c;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(c);break}a[2]&&s.ops.pop(),s.trys.pop();continue}c=t.call(e,s)}catch(e){c=[6,e],n=0}finally{r=a=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}var k=s.z.object({accessToken:s.z.string(),refreshToken:s.z.string(),expiresAt:s.z.number()}),S=s.z.discriminatedUnion("state",[s.z.object({state:s.z.literal("signedOut"),email:s.z.nullable(s.z.string())}),s.z.object({state:s.z.literal("signedIn"),token:k,email:s.z.string(),persistentId:s.z.string()})]),O="quizAuthenticationState",j="codeVerifier",E=new n.lv({server:"https://accounts.google.com",clientId:"866758015458-r7t30bm7b492c1mevid587apej6cjte6.apps.googleusercontent.com",clientSecret:"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",discoveryEndpoint:"/.well-known/openid-configuration"}),I=(0,i.Sz)({kind:"oauthCallback",params:{}}).toString();function P(){var e=localStorage.getItem(O);if(null!==e){var t=S.safeParse(JSON.parse(e));if(t.success)return t.data;d.error("Failed to parse ".concat(O,", using default state"),t.error)}return{state:"signedOut",email:null}}var z=function(){var e;function t(){var e,r=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");v(this,"_state",void 0),v(this,"stateObservers",new Set),v(this,"isSyncing",!1),this._state=P(),addEventListener("storage",function(e){e.key===O&&(r._state=P(),r.stateObservers.forEach(function(e){e()}))}),f.QuizModel.shared.uniquePersistentId.observers.add(function(){return r.syncEmailAssociation()}),this.syncEmailAssociation();var n=function(){r.isSyncing||(clearTimeout(e),e=setTimeout(function(){return r.syncProfile()},1e3))};f.QuizModel.shared.history.observers.add(n),f.QuizModel.shared.friends.observers.add(n),window.addEventListener("focus",n),this.syncProfile().catch(function(e){d.error("Error syncing profile",e)})}return e=[{key:"state",get:function(){return this._state}},{key:"setState",value:function(e){this._state=e,localStorage.setItem(O,JSON.stringify(e)),this.stateObservers.forEach(function(e){e()})}},{key:"useState",value:function(){var e=this,t=m((0,a.useState)(0),2)[1];return(0,a.useEffect)(function(){var r=function(){t(function(e){return e+1})};return e.stateObservers.add(r),function(){e.stateObservers.delete(r)}},[]),this._state}},{key:"syncProfile",value:function(e){return b(function(){var t;return w(this,function(r){switch(r.label){case 0:if(o.k.shared.testSyncing=!0,void 0!==e)return[3,2];return[4,this.getAccessToken()];case 1:e=r.sent(),r.label=2;case 2:if(void 0===e)return[2];r.label=3;case 3:return r.trys.push([3,5,6,7]),this.isSyncing=!0,[4,(0,h.by)(e)];case 4:return r.sent(),[3,7];case 5:var n,a;throw n=t=r.sent(),(null!=(a=h._7)&&"undefined"!=typeof Symbol&&a[Symbol.hasInstance]?!!a[Symbol.hasInstance](n):n instanceof a)&&this.authenticationError(),t;case 6:return this.isSyncing=!1,o.k.shared.testSyncing=!1,[7];case 7:return[2]}})}).call(this)}},{key:"syncEmailAssociation",value:function(){return b(function(){var e,t;return w(this,function(r){switch(r.label){case 0:if("signedIn"!==this._state.state||f.QuizModel.shared.uniquePersistentId.value===this._state.persistentId)return[3,2];return[4,this.userSignOut()];case 1:case 4:return r.sent(),[2];case 2:return[4,l.G.GET("/juxtastat/email",{params:{header:f.QuizModel.shared.userHeaders()}})];case 3:if(!(e=r.sent().data))return[3,8];if(null===e.email||"signedOut"!==this._state.state)return[3,5];return[4,this.userSignOut()];case 5:return[4,this.getAccessToken()];case 6:if(t=r.sent(),null!==e.email||void 0===t)return[3,8];return[4,this.associateEmail(t)];case 7:r.sent(),r.label=8;case 8:return[2]}})}).call(this)}},{key:"startSignIn",value:function(){return b(function(){var e,t;return w(this,function(r){switch(r.label){case 0:return[4,(0,n.Uj)()];case 1:return e=r.sent(),[4,E.authorizationCode.getAuthorizeUri({redirectUri:I,codeVerifier:e,scope:["email","https://www.googleapis.com/auth/drive.appdata"],extraParams:{access_type:"offline",prompt:"consent"}})];case 2:return t=r.sent(),[2,{start:function(){window.open(t,"_blank","popup,width=500,height=600"),localStorage.setItem(j,e)}}]}})})()}},{key:"useStartSignIn",value:function(){var e=this,t=m((0,a.useState)(void 0),2),r=t[0],n=t[1];return(0,a.useEffect)(function(){e.startSignIn().then(n)},[]),null==r?void 0:r.start}},{key:"completeSignIn",value:function(e){return b(function(){var t,r,n,a,s;return w(this,function(o){switch(o.label){case 0:var l,h,d;if("signedOut"!==this._state.state)throw Error("Already signed in");if(t=(0,i.Sz)(e),null===(r=localStorage.getItem(j)))throw Error("No code verifier was stored");return localStorage.removeItem(j),[4,(l=2,h=function(){return E.authorizationCode.getTokenFromCodeRedirect(t,{redirectUri:I,codeVerifier:r})},(d=function(){var e;return function(e,t){var r,n,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=o(0),i.throw=o(1),i.return=o(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(o){return function(u){var c=[o,u];if(r)throw TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(s=0)),s;)try{if(r=1,n&&(a=2&c[0]?n.return:c[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,c[1])).done)return a;switch(n=0,a&&(c=[2&c[0],a.value]),c[0]){case 0:case 1:a=c;break;case 4:return s.label++,{value:c[1],done:!1};case 5:s.label++,n=c[1],c=[0];continue;case 7:c=s.ops.pop(),s.trys.pop();continue;default:if(!(a=(a=s.trys).length>0&&a[a.length-1])&&(6===c[0]||2===c[0])){s=0;continue}if(3===c[0]&&(!a||c[1]>a[0]&&c[1]<a[3])){s.label=c[1];break}if(6===c[0]&&s.label<a[1]){s.label=a[1],a=c;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(c);break}a[2]&&s.ops.pop(),s.trys.pop();continue}c=t.call(e,s)}catch(e){c=[6,e],n=0}finally{r=a=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}(this,function(t){switch(t.label){case 0:t.label=1;case 1:return t.trys.push([1,3,,4]),[4,h()];case 2:return[2,t.sent()];case 3:if(e=t.sent(),--l>0)u.warn("Retrying...",e);else throw e;return[3,4];case 4:return[3,0];case 5:return[2]}})},function(){var e=this,t=arguments;return new Promise(function(r,n){var a=d.apply(e,t);function s(e){c(a,r,n,s,i,"next",e)}function i(e){c(a,r,n,s,i,"throw",e)}s(void 0)})})())];case 1:return n=o.sent(),a=k.parse(n),[4,this.associateEmail(a.accessToken)];case 2:return s=o.sent(),[4,this.syncProfile(a.accessToken)];case 3:return o.sent(),this.setState({state:"signedIn",token:{refreshToken:a.refreshToken,accessToken:a.accessToken,expiresAt:a.expiresAt},email:s,persistentId:f.QuizModel.shared.uniquePersistentId.value}),[2]}})}).call(this)}},{key:"associateEmail",value:function(e){return b(function(){var t,r,n;return w(this,function(a){switch(a.label){case 0:return[4,l.G.POST("/juxtastat/associate_email",{params:{header:g({},f.QuizModel.shared.userHeaders())},body:{token:e}})];case 1:if(r=(t=a.sent()).response,n=t.data)return[2,n.email];if(409===r.status)throw Error("This device is already associated with a different email.");throw Error("Unknown error from server: ".concat(r.status))}})})()}},{key:"authenticationError",value:function(){this.setState({state:"signedOut",email:this._state.email})}},{key:"userSignOut",value:function(){return b(function(){return w(this,function(e){switch(e.label){case 0:return[4,l.G.POST("/juxtastat/dissociate_email",{params:{header:f.QuizModel.shared.userHeaders()}})];case 1:return e.sent().error||this.setState({state:"signedOut",email:null}),[2]}})}).call(this)}},{key:"getAccessToken",value:function(){return b(function(){var e,t,r;return w(this,function(n){switch(n.label){case 0:if("signedOut"===this._state.state)return[2,void 0];if(Date.now()+1e4<this._state.token.expiresAt)return[2,this._state.token.accessToken];n.label=1;case 1:return n.trys.push([1,3,,4]),t=k.parse,[4,E.refreshToken(this._state.token)];case 2:var a,s;return e=t.apply(k,[n.sent()]),this.setState((a=g({},this._state),s=s={token:e},Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(s)):(function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r})(Object(s)).forEach(function(e){Object.defineProperty(a,e,Object.getOwnPropertyDescriptor(s,e))}),a)),[2,e.accessToken];case 3:return r=n.sent(),d.error("Error while refreshing access token",r),this.authenticationError(),[2,void 0];case 4:return[2]}})}).call(this)}}],function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(t.prototype,e),t}();v(z,"shared",new z)},4334:function(e,t,r){r.d(t,{G:()=>o});var n=r(36129),a=r(65438),s=r(51647);function i(e,t,r,n,a,s,i){try{var o=e[s](i),u=o.value}catch(e){r(e);return}o.done?t(u):Promise.resolve(u).then(n,a)}var o=(0,n.ZP)({baseUrl:s.k.shared.isTesting?"http://localhost:54579":"https://persistent.urbanstats.org",fetch:function(e){var t;return(t=function(){var t;return function(e,t){var r,n,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=o(0),i.throw=o(1),i.return=o(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(o){return function(u){var c=[o,u];if(r)throw TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(s=0)),s;)try{if(r=1,n&&(a=2&c[0]?n.return:c[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,c[1])).done)return a;switch(n=0,a&&(c=[2&c[0],a.value]),c[0]){case 0:case 1:a=c;break;case 4:return s.label++,{value:c[1],done:!1};case 5:s.label++,n=c[1],c=[0];continue;case 7:c=s.ops.pop(),s.trys.pop();continue;default:if(!(a=(a=s.trys).length>0&&a[a.length-1])&&(6===c[0]||2===c[0])){s=0;continue}if(3===c[0]&&(!a||c[1]>a[0]&&c[1]<a[3])){s.label=c[1];break}if(6===c[0]&&s.label<a[1]){s.label=a[1],a=c;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(c);break}a[2]&&s.ops.pop(),s.trys.pop();continue}c=t.call(e,s)}catch(e){c=[6,e],n=0}finally{r=a=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}(this,function(r){switch(r.label){case 0:return[4,globalThis.fetch(e)];case 1:return 401===(t=r.sent()).status&&(a.QuizModel.shared.authenticationError.value=!0),[2,t]}})},function(){var e=this,r=arguments;return new Promise(function(n,a){var s=t.apply(e,r);function o(e){i(s,n,a,o,u,"next",e)}function u(e){i(s,n,a,o,u,"throw",e)}o(void 0)})})()}})}}]);
//# sourceMappingURL=204.js.map